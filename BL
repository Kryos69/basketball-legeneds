-- // Load Rayfield UI Library
local Rayfield = loadstring(game:HttpGet("https://sirius.menu/rayfield"))()

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

local localPlayer = Players.LocalPlayer

-- Control Service Remotes
local ControlServiceRE = ReplicatedStorage.Packages.Knit.Services.ControlService.RE
local StartShoot = ControlServiceRE.StartShoot
local Shoot = ControlServiceRE.Shoot
local StartDunkRemote = ControlServiceRE.StartDunk

-- Animations folder for dunking
local animationsFolder = ReplicatedStorage:WaitForChild("Assets"):WaitForChild("Animations_R15")

-- === Window & Tabs ===
local Window = Rayfield:CreateWindow({
	Name = "Spare Stack",
	LoadingTitle = "Loading...",
	ConfigurationSaving = { Enabled = false }
})

local mainTab = Window:CreateTab("Main", 4483362458)
local playerTab = Window:CreateTab("Player", 4483362458)
local miscTab = Window:CreateTab("Misc", 4483362458)

-- === Auto Green ===
local autoGreenEnabled = false

local function runShootingSequence()
	StartShoot:FireServer()
	task.wait(0.23)
	Shoot:FireServer(1)
	task.wait(0.23)
	Shoot:FireServer(0)
end

UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if autoGreenEnabled and input.KeyCode == Enum.KeyCode.E then
		runShootingSequence()
	end
end)

mainTab:CreateToggle({
	Name = "Enable Auto Green (E key)",
	CurrentValue = false,
	Callback = function(state)
		autoGreenEnabled = state
	end
})

-- === Walkspeed ===
local walkspeedEnabled = false
local walkspeedValue = 16
local moveConnection

local function cframeWalkspeed()
	if moveConnection then
		moveConnection:Disconnect()
		moveConnection = nil
	end

	if walkspeedEnabled then
		moveConnection = RunService.Heartbeat:Connect(function(deltaTime)
			local char = localPlayer.Character
			if not char then return end
			local hrp = char:FindFirstChild("HumanoidRootPart")
			local humanoid = char:FindFirstChildOfClass("Humanoid")
			if not hrp or not humanoid then return end

			local moveDir = humanoid.MoveDirection
			if moveDir.Magnitude > 0 then
				hrp.CFrame = hrp.CFrame + (moveDir.Unit * walkspeedValue * deltaTime)
			end
		end)
	end
end

playerTab:CreateToggle({
	Name = "Enable Walkspeed",
	CurrentValue = false,
	Callback = function(state)
		walkspeedEnabled = state
		cframeWalkspeed()
	end
})

playerTab:CreateSlider({
	Name = "Walkspeed Value",
	Range = {1, 100},
	Increment = 1,
	Suffix = "Speed",
	CurrentValue = 16,
	Callback = function(value)
		walkspeedValue = value
	end
})

-- === Hitbox Expander ===
local hitboxEnabled = false
local hitboxRadius = 50
local hitboxConnection

local function simulateTouch(ball)
	local character = localPlayer.Character
	if not character then return end
	local rootPart = character:FindFirstChild("HumanoidRootPart")
	if not rootPart then return end

	firetouchinterest(rootPart, ball, 0)
	task.wait()
	firetouchinterest(rootPart, ball, 1)
end

local function hitboxExpander()
	if hitboxConnection then
		hitboxConnection:Disconnect()
		hitboxConnection = nil
	end

	if hitboxEnabled then
		hitboxConnection = RunService.Heartbeat:Connect(function()
			local character = localPlayer.Character
			if not character then return end
			local rootPart = character:FindFirstChild("HumanoidRootPart")
			if not rootPart then return end

			for _, ball in pairs(Workspace:GetChildren()) do
				if ball:IsA("BasePart") and ball.Name == "Basketball" then
					local distance = (ball.Position - rootPart.Position).Magnitude
					if distance <= hitboxRadius then
						simulateTouch(ball)
					end
				end
			end
		end)
	end
end

playerTab:CreateToggle({
	Name = "Enable Hitbox Expander",
	CurrentValue = false,
	Callback = function(state)
		hitboxEnabled = state
		hitboxExpander()
	end
})

playerTab:CreateSlider({
	Name = "Hitbox Radius",
	Range = {10, 100},
	Increment = 1,
	Suffix = "Studs",
	CurrentValue = 50,
	Callback = function(value)
		hitboxRadius = value
	end
})

-- === Noclip ===
local noclipEnabled = false
local noclipConnection

local function setCollisions(state)
	local character = localPlayer.Character
	if not character then return end

	for _, part in pairs(character:GetDescendants()) do
		if part:IsA("BasePart") then
			part.CanCollide = state
		end
	end
end

local function noclip()
	if noclipConnection then
		noclipConnection:Disconnect()
		noclipConnection = nil
	end

	if noclipEnabled then
		noclipConnection = RunService.Stepped:Connect(function()
			local character = localPlayer.Character
			if not character then return end

			for _, part in pairs(character:GetDescendants()) do
				if part:IsA("BasePart") and part.CanCollide then
					part.CanCollide = false
				end
			end
		end)
	else
		setCollisions(true)
	end
end

playerTab:CreateToggle({
	Name = "Enable Noclip",
	CurrentValue = false,
	Callback = function(state)
		noclipEnabled = state
		noclip()
	end
})

-- === Misc: Lay on Ground (simple ragdoll-ish) ===
miscTab:CreateButton({
	Name = "Lay on Ground (Ragdoll)",
	Callback = function()
		local character = localPlayer.Character
		if character and character:FindFirstChild("HumanoidRootPart") and character:FindFirstChildOfClass("Humanoid") then
			local humanoid = character:FindFirstChildOfClass("Humanoid")
			humanoid:ChangeState(Enum.HumanoidStateType.Physics)
			local hrp = character:FindFirstChild("HumanoidRootPart")
			if hrp then
				hrp.CFrame = hrp.CFrame * CFrame.Angles(math.rad(90), 0, 0)
			end
		end
	end
})

-- === Dunker Changer Setup ===
local dunkAnimations = {
	"Dunk_Default",
	"Dunk_Reverse",
	"Dunk_Tomahawk",
	"Dunk_Windmill"
}

local currentDunkTrack = nil
local selectedDunkAnimation = dunkAnimations[1]

local function playDunkAnimation(animName)
	local character = localPlayer.Character
	if not character then return end
	local humanoid = character:FindFirstChildOfClass("Humanoid")
	if not humanoid then return end

	if currentDunkTrack then
		currentDunkTrack:Stop()
		currentDunkTrack:Destroy()
		currentDunkTrack = nil
	end

	local animObj = animationsFolder:FindFirstChild(animName)
	if animObj and animObj:IsA("Animation") then
		currentDunkTrack = humanoid:LoadAnimation(animObj)
		currentDunkTrack:Play()
	else
		warn("Animation "..animName.." not found!")
	end
end

-- Override StartDunk Remote to play selected animation on dunk
local oldStartDunkFireServer = StartDunkRemote.FireServer

StartDunkRemote.FireServer = function(self, ...)
	oldStartDunkFireServer(self, ...)
	playDunkAnimation(selectedDunkAnimation)
end

-- Add Dunker Changer dropdown to misc tab
miscTab:CreateDropdown({
	Name = "Dunker Changer",
	Options = dunkAnimations,
	CurrentOption = selectedDunkAnimation,
	Callback = function(option)
		selectedDunkAnimation = option
	end
})
